<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Quest: Infinite Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #58cc02; --error: #ff4b4b; --blue: #1cb0f6; --gray: #e5e5e5; }
        body { font-family: 'Outfit', sans-serif; margin: 0; background: #f0f2f5; color: #3c3c3c; }
        
        .header { position: sticky; top: 0; background: white; padding: 15px; display: flex; justify-content: space-around; border-bottom: 2px solid var(--gray); z-index: 100; }
        .stat { font-weight: 900; }

        .path { display: flex; flex-direction: column-reverse; align-items: center; padding: 60px 0; }
        .node { width: 70px; height: 70px; border-radius: 50%; border: none; margin: 10px 0; color: white; font-weight: 900; cursor: pointer; transition: 0.2s; box-shadow: 0 6px 0 #afafaf; background: var(--gray); }
        .unlocked { background: var(--primary); box-shadow: 0 6px 0 #46a302; }
        .current { transform: scale(1.2); border: 4px solid var(--blue); }

        .jump-box { position: fixed; bottom: 20px; right: 20px; }
        .btn-jump { background: var(--blue); color: white; border: none; padding: 15px 25px; border-radius: 50px; font-weight: 900; cursor: pointer; box-shadow: 0 5px 0 #1589bd; }

        .overlay { position: fixed; inset: 0; background: white; display: none; flex-direction: column; z-index: 200; }
        .lesson-body { padding: 40px 20px; max-width: 500px; margin: 0 auto; text-align: center; width: 100%; box-sizing: border-box; }
        .q-text { font-size: 1.5rem; font-weight: 700; margin-bottom: 30px; }
        .opt { display: block; width: 100%; padding: 15px; margin: 10px 0; border: 2px solid var(--gray); border-radius: 15px; background: white; font-weight: 700; cursor: pointer; }
        .correct { background: #dcfce7 !important; border-color: var(--primary) !important; }
        .wrong { background: #fee2e2 !important; border-color: var(--error) !important; }
    </style>
</head>
<body>

    <div class="header">
        <div class="stat" style="color:var(--primary)">LVL <span id="ui-lvl">1</span></div>
        <div class="stat" style="color:var(--error)">‚ù§Ô∏è <span id="ui-hearts">5</span></div>
    </div>

    <div class="path" id="map"></div>

    <div class="jump-box">
        <button class="btn-jump" onclick="requestJump()">‚ö° JUMP +10</button>
    </div>

    <div class="overlay" id="ui-lesson">
        <div style="padding: 15px; border-bottom: 2px solid var(--gray); display: flex; align-items: center; gap: 20px;">
            <button onclick="exit()" style="border:none; background:none; font-size:2rem; cursor:pointer">‚úï</button>
            <div style="flex-grow:1; height:12px; background:var(--gray); border-radius:6px; overflow:hidden;">
                <div id="p-bar" style="height:100%; background:var(--primary); width:0%; transition:0.3s;"></div>
            </div>
        </div>
        <div class="lesson-body" id="l-content"></div>
    </div>

<script>
    // --- MOTOR INFINITO (Generador de Frases) ---
    const vocabulary = {
        subjects: ["The manager", "A student", "My parents", "The scientist", "The CEO", "An artist", "The team"],
        actions: [
            { v: "working", prep: "on", lvl: 1 },
            { v: "looking forward", prep: "to", lvl: 20 },
            { v: "accustomed", prep: "to", lvl: 40 },
            { v: "responsible", prep: "for", lvl: 10 },
            { v: "interested", prep: "in", lvl: 5 }
        ],
        objects: ["the new project", "learning French", "solving the issue", "meeting the clients", "improving the code"]
    };

    let userLvl = parseInt(localStorage.getItem('inf_lvl')) || 1;
    let hearts = 5;
    let session = { active: false, step: 0, total: 5, jump: false, questions: [] };

    const audio = new (window.AudioContext || window.webkitAudioContext)();
    function beep(f) {
        const o = audio.createOscillator(); const g = audio.createGain();
        o.connect(g); g.connect(audio.destination); o.frequency.value = f;
        g.gain.setValueAtTime(0.1, audio.currentTime); g.gain.linearRampToValueAtTime(0, audio.currentTime + 0.3);
        o.start(); o.stop(audio.currentTime + 0.3);
    }

    function generateQuestion(lvl) {
        const type = Math.random() > 0.5 ? 'preposition' : 'tense';
        const subj = vocabulary.subjects[Math.floor(Math.random() * vocabulary.subjects.length)];
        const action = vocabulary.actions.filter(a => a.lvl <= lvl).sort(() => 0.5 - Math.random())[0];
        const obj = vocabulary.objects[Math.floor(Math.random() * vocabulary.objects.length)];

        if(type === 'preposition') {
            return {
                q: `${subj} is ${action.v} ____ ${obj}.`,
                a: [action.prep, "at", "with"].sort(() => 0.5 - Math.random()),
                c: action.prep
            };
        } else {
            return {
                q: `If I ____ you, I would study more. (Lvl ${lvl} logic)`,
                a: ["was", "were", "am"],
                c: "were"
            };
        }
    }

    function renderMap() {
        const map = document.getElementById('map'); map.innerHTML = '';
        for(let i = 1; i <= 100; i++) {
            const btn = document.createElement('button');
            btn.className = `node ${i <= userLvl ? 'unlocked' : ''} ${i === userLvl ? 'current' : ''}`;
            btn.innerHTML = i;
            btn.onclick = () => start(i);
            btn.style.marginLeft = `${Math.sin(i) * 50}px`;
            map.appendChild(btn);
        }
        document.getElementById('ui-lvl').innerText = userLvl;
        window.scrollTo(0, document.body.scrollHeight);
    }

    function start(lvl, isJump = false) {
        if(lvl > userLvl && !isJump) return;
        session = { active: true, step: 0, total: isJump ? 10 : 5, jump: isJump, target: lvl, questions: [] };
        for(let i=0; i<session.total; i++) session.questions.push(generateQuestion(lvl));
        document.getElementById('ui-lesson').style.display = 'flex';
        renderQ();
    }

    function renderQ() {
        const q = session.questions[session.step];
        const cont = document.getElementById('l-content');
        document.getElementById('p-bar').style.width = `${(session.step / session.total) * 100}%`;
        document.getElementById('ui-hearts').innerText = hearts;

        cont.innerHTML = `
            <div style="color:var(--blue); font-weight:900; margin-bottom:10px;">${session.jump ? 'üî• JUMP TEST' : 'LEVEL ' + session.target}</div>
            <div class="q-text">${q.q}</div>
            ${q.a.map(opt => `<button class="opt" onclick="check('${opt}', '${q.c}')">${opt}</button>`).join('')}
        `;
    }

    function check(ans, correct) {
        const all = document.querySelectorAll('.opt');
        if(ans === correct) {
            beep(600);
            session.step++;
            if(session.step >= session.total) {
                if(session.jump) userLvl = session.target; else if(session.target === userLvl) userLvl++;
                localStorage.setItem('inf_lvl', userLvl);
                alert("SUCCESS!"); exit(); renderMap();
            } else renderQ();
        } else {
            beep(200);
            hearts--;
            if(session.jump || hearts <= 0) { alert("FAILED! Progress reset."); hearts=5; exit(); }
            else renderQ();
        }
    }

    function requestJump() {
        const target = userLvl + 10;
        if(confirm(`Attempt Jump to Level ${target}? Fail = Game Over.`)) start(target, true);
    }

    function exit() { document.getElementById('ui-lesson').style.display = 'none'; }
    renderMap();
</script>
</body>
</html>
            { t: "Grammar", q: "She ___ to music every day.", a: ["listen", "listens", "listening"], c: 1 }
        ],
        intermediate: [ // Nivel 21-50
            { t: "Phrasal Verb", q: "I need to ___ the truth.", a: ["find out", "find in", "find up"], c: 0 },
            { t: "Conditionals", q: "If I won the lottery, I ___ a car.", a: ["will buy", "would buy", "bought"], c: 1 },
            { t: "Idiom", q: "'Break a leg' means...", a: ["Good luck", "You failed", "Accident"], c: 0 }
        ],
        advanced: [ // Nivel 51-80
            { t: "Modals", q: "He ___ have been there; he was with me.", a: ["mustn't", "can't", "shouldn't"], c: 1 },
            { t: "Passive", q: "The bridge ___ by next month.", a: ["is repaired", "will be repaired", "will have repaired"], c: 1 },
            { t: "Subjunctive", q: "It's vital that he ___ present.", a: ["is", "be", "was"], c: 1 }
        ],
        expert: [ // Nivel 81-100
            { t: "Inversion", q: "Seldom ___ such a beautiful sunset.", a: ["I have seen", "have I seen", "did I saw"], c: 1 },
            { t: "Mixed Conditional", q: "If I had studied, I ___ a degree now.", a: ["would have", "would have had", "will have"], c: 0 },
            { t: "C2 Structures", q: "Were it not for your help, I ___.", a: ["failed", "would fail", "would have failed"], c: 2 }
        ]
    };

    let userLvl = parseInt(localStorage.getItem('edu_lvl')) || 1;
    let hearts = 5;
    let currentTask = [];
    let step = 0;
    let isBoss = false;

    // Sonidos
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    function beep(f, t) {
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.type = t; o.frequency.value = f;
        g.gain.setValueAtTime(0.1, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        o.start(); o.stop(ctx.currentTime + 0.3);
    }

    function renderMap() {
        const map = document.getElementById('map'); map.innerHTML = '';
        for(let i = 1; i <= 100; i++) {
            const btn = document.createElement('button');
            const isBossLvl = i % 10 === 0;
            btn.className = `level-node ${i <= userLvl ? 'unlocked' : ''} ${i === userLvl ? 'current' : ''} ${isBossLvl ? 'boss-node' : ''}`;
            btn.innerHTML = isBossLvl ? 'üíÄ' : i;
            btn.onclick = () => startSession(i, isBossLvl);
            btn.style.marginLeft = `${Math.sin(i * 0.9) * 65}px`;
            map.appendChild(btn);
        }
        document.getElementById('user-lvl').innerText = userLvl;
        window.scrollTo(0, document.body.scrollHeight);
    }

    function startSession(lvl, boss) {
        if(lvl > userLvl || hearts <= 0) return;
        step = 0; isBoss = boss;
        
        // Seleccionar dificultad seg√∫n nivel
        let pool = content.beginner;
        if(lvl > 20) pool = content.intermediate;
        if(lvl > 50) pool = content.advanced;
        if(lvl > 80) pool = content.expert;

        currentTask = [...pool].sort(() => 0.5 - Math.random()).slice(0, boss ? 10 : 5);
        document.getElementById('lesson-ui').style.display = 'flex';
        renderQuestion();
    }

    function renderQuestion() {
        const q = currentTask[step];
        const contentEl = document.getElementById('lesson-content');
        document.getElementById('p-fill').style.width = `${(step / currentTask.length) * 100}%`;

        contentEl.innerHTML = `
            <span class="type-label">${q.t} ${isBoss ? '‚Ä¢ BOSS MODE' : ''}</span>
            <div class="question">${q.q}</div>
            <div class="option-grid">
                ${q.a.map((opt, i) => `<button class="opt" onclick="check(${i}, ${q.c})">${opt}</button>`).join('')}
            </div>
        `;
    }

    function check(idx, correct) {
        const btns = document.querySelectorAll('.opt');
        btns.forEach(b => b.disabled = true);

        if(idx === correct) {
            btns[idx].classList.add('correct'); beep(600, 'sine');
            setTimeout(() => {
                step++;
                if(step < currentTask.length) renderQuestion();
                else finish();
            }, 800);
        } else {
            btns[idx].classList.add('wrong'); beep(150, 'triangle');
            hearts--; document.getElementById('hearts-val').innerText = hearts;
            if(isBoss || hearts <= 0) {
                alert(isBoss ? "BOSS DEFEATED YOU! Start level again." : "No more lives!");
                exitLesson();
            } else {
                setTimeout(() => { btns.forEach(b => b.disabled = false); btns[idx].classList.remove('wrong'); }, 800);
            }
        }
    }

    function finish() {
        if(userLvl < 100) userLvl++;
        localStorage.setItem('edu_lvl', userLvl);
        alert("Level Clear! +10 XP");
        exitLesson(); renderMap();
    }

    function exitLesson() { document.getElementById('lesson-ui').style.display = 'none'; }
    renderMap();
</script>
</body>
</html>
            btn.className = `level-node ${i <= userLvl ? 'unlocked' : ''} ${i === userLvl ? 'current' : ''}`;
            btn.innerHTML = i;
            btn.onclick = () => startSession(i);
            btn.style.marginLeft = `${Math.sin(i * 0.8) * 60}px`;
            map.appendChild(btn);
        }
        document.getElementById('user-lvl').innerText = userLvl;
        window.scrollTo(0, document.body.scrollHeight);
    }

    function startSession(lvl) {
        if(lvl > userLvl || totalHearts <= 0) return;
        currentStep = 0;
        // Mezclamos y seleccionamos 5 preguntas √∫nicas
        currentQuestions = [...questionBank].sort(() => 0.5 - Math.random()).slice(0, QUESTIONS_PER_LEVEL);
        document.getElementById('lesson-ui').style.display = 'flex';
        renderQuestion();
    }

    function renderQuestion() {
        const q = currentQuestions[currentStep];
        const body = document.getElementById('lesson-body');
        document.getElementById('lesson-hearts').innerText = totalHearts;
        document.getElementById('p-bar').style.width = `${(currentStep / QUESTIONS_PER_LEVEL) * 100}%`;

        body.innerHTML = `
            <div class="q-text">${q.q}</div>
            <div id="opts">
                ${q.a.map((opt, i) => `<button class="option" onclick="handleSelect(this, ${i})">${opt}</button>`).join('')}
            </div>
        `;
    }

    function handleSelect(btn, idx) {
        const q = currentQuestions[currentStep];
        const allOpts = document.querySelectorAll('.option');
        allOpts.forEach(o => o.style.pointerEvents = 'none');

        if(idx === q.c) {
            btn.classList.add('correct');
            playSound(880, 'sine'); // Sonido acierto (La5)
            setTimeout(() => {
                currentStep++;
                if(currentStep < QUESTIONS_PER_LEVEL) {
                    renderQuestion();
                } else {
                    completeLevel();
                }
            }, 1000);
        } else {
            btn.classList.add('wrong');
            playSound(220, 'square'); // Sonido fallo (La3)
            totalHearts--;
            document.getElementById('lesson-hearts').innerText = totalHearts;
            document.getElementById('global-hearts').innerText = totalHearts;
            
            setTimeout(() => {
                if(totalHearts <= 0) {
                    alert("GAME OVER - Vuelve a empezar");
                    location.reload();
                } else {
                    renderQuestion(); // Re-intenta la misma
                }
            }, 1000);
        }
    }

    function completeLevel() {
        if(userLvl < 100) userLvl++;
        localStorage.setItem('userLvl', userLvl);
        alert("¬°Nivel superado!");
        exitLesson();
        renderMap();
    }

    function exitLesson() {
        document.getElementById('lesson-ui').style.display = 'none';
    }

    renderMap();
</script>
</body>
</html>
        { q: "Unless it ___ , we'll go out.", a: ["rains", "will rain", "rained"], c: 0, tag: "conditional" }
    ];

    let userLvl = parseInt(localStorage.getItem('userLvl')) || 1;
    let totalHearts = 5;
    let currentQuestions = [];
    let currentStep = 0;
    const QUESTIONS_PER_LEVEL = 5;

    // --- SOUND ENGINE (Web Audio API) ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(freq, type) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.type = type; osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        osc.start(); osc.stop(audioCtx.currentTime + 0.3);
    }

    // --- GAME LOGIC ---
    function renderMap() {
        const map = document.getElementById('map');
        map.innerHTML = '';
        for(let i = 1; i <= 100; i++) {
            const btn = document.createElement('button');
            btn.className = `level-node ${i <= userLvl ? 'unlocked' : ''} ${i === userLvl ? 'current' : ''}`;
            btn.innerHTML = i;
            btn.onclick = () => startSession(i);
            btn.style.marginLeft = `${Math.sin(i * 0.8) * 60}px`;
            map.appendChild(btn);
        }
        document.getElementById('user-lvl').innerText = userLvl;
        window.scrollTo(0, document.body.scrollHeight);
    }

    function startSession(lvl) {
        if(lvl > userLvl || totalHearts <= 0) return;
        currentStep = 0;
        // Mezclamos y seleccionamos 5 preguntas √∫nicas
        currentQuestions = [...questionBank].sort(() => 0.5 - Math.random()).slice(0, QUESTIONS_PER_LEVEL);
        document.getElementById('lesson-ui').style.display = 'flex';
        renderQuestion();
    }

    function renderQuestion() {
        const q = currentQuestions[currentStep];
        const body = document.getElementById('lesson-body');
        document.getElementById('lesson-hearts').innerText = totalHearts;
        document.getElementById('p-bar').style.width = `${(currentStep / QUESTIONS_PER_LEVEL) * 100}%`;

        body.innerHTML = `
            <div class="q-text">${q.q}</div>
            <div id="opts">
                ${q.a.map((opt, i) => `<button class="option" onclick="handleSelect(this, ${i})">${opt}</button>`).join('')}
            </div>
        `;
    }

    function handleSelect(btn, idx) {
        const q = currentQuestions[currentStep];
        const allOpts = document.querySelectorAll('.option');
        allOpts.forEach(o => o.style.pointerEvents = 'none');

        if(idx === q.c) {
            btn.classList.add('correct');
            playSound(880, 'sine'); // Sonido acierto (La5)
            setTimeout(() => {
                currentStep++;
                if(currentStep < QUESTIONS_PER_LEVEL) {
                    renderQuestion();
                } else {
                    completeLevel();
                }
            }, 1000);
        } else {
            btn.classList.add('wrong');
            playSound(220, 'square'); // Sonido fallo (La3)
            totalHearts--;
            document.getElementById('lesson-hearts').innerText = totalHearts;
            document.getElementById('global-hearts').innerText = totalHearts;
            
            setTimeout(() => {
                if(totalHearts <= 0) {
                    alert("GAME OVER - Vuelve a empezar");
                    location.reload();
                } else {
                    renderQuestion(); // Re-intenta la misma
                }
            }, 1000);
        }
    }

    function completeLevel() {
        if(userLvl < 100) userLvl++;
        localStorage.setItem('userLvl', userLvl);
        alert("¬°Nivel superado!");
        exitLesson();
        renderMap();
    }

    function exitLesson() {
        document.getElementById('lesson-ui').style.display = 'none';
    }

    renderMap();
</script>
</body>
</html>
