<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Quest Infinity</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --p: #58cc02; --pd: #46a302; --e: #ff4b4b; --b: #1cb0f6; --g: #e5e5e5; --txt: #3c3c3c; }
        body { font-family: 'Outfit', sans-serif; margin: 0; background: #fff; color: var(--txt); overflow-x: hidden; }
        
        /* Dashboard */
        .header { position: sticky; top: 0; background: white; padding: 15px; display: flex; justify-content: space-around; border-bottom: 2px solid var(--g); z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat { font-weight: 900; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }

        /* Level Map */
        .path { display: flex; flex-direction: column-reverse; align-items: center; padding: 60px 0; background: #f7f7f7; min-height: 100vh; }
        .node { 
            width: 85px; height: 80px; border-radius: 50%; border: none; margin: 15px 0;
            color: white; font-weight: 900; cursor: pointer; transition: 0.2s;
            box-shadow: 0 8px 0 #afafaf; background: var(--g); font-size: 1.3rem;
        }
        .unlocked { background: var(--p); box-shadow: 0 8px 0 var(--pd); }
        .current { transform: scale(1.2); border: 4px solid var(--b); animation: float 2s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: scale(1.2) translateY(0); } 50% { transform: scale(1.2) translateY(-10px); } }

        /* Lesson UI */
        .overlay { position: fixed; inset: 0; background: white; display: none; flex-direction: column; z-index: 200; }
        .l-header { padding: 20px; display: flex; align-items: center; gap: 20px; }
        .progress { flex-grow: 1; height: 16px; background: var(--g); border-radius: 8px; overflow: hidden; }
        .bar { height: 100%; background: var(--p); width: 0%; transition: 0.4s; }
        
        .l-body { padding: 40px 20px; max-width: 500px; margin: 0 auto; text-align: center; width: 100%; box-sizing: border-box; }
        .type { color: var(--b); font-weight: 900; text-transform: uppercase; font-size: 0.9rem; margin-bottom: 10px; display: block; }
        .q-text { font-size: 1.8rem; font-weight: 700; margin-bottom: 30px; line-height: 1.3; }

        /* Options */
        .opt { 
            display: block; width: 100%; padding: 18px; margin: 12px 0; 
            border: 2px solid var(--g); border-bottom: 6px solid var(--g);
            border-radius: 18px; background: white; font-size: 1.1rem; font-weight: 700;
            cursor: pointer; transition: 0.1s; text-align: left;
        }
        .opt:hover { background: #f8fafc; }
        .opt:active { transform: translateY(4px); border-bottom-width: 2px; }
        .correct { background: #dcfce7 !important; border-color: var(--p) !important; color: #166534; }
        .wrong { background: #fee2e2 !important; border-color: var(--e) !important; color: #991b1b; }

        /* Speaking Mic */
        .mic-btn { 
            width: 100px; height: 100px; border-radius: 50%; background: var(--e); 
            border: none; color: white; font-size: 2rem; cursor: pointer;
            box-shadow: 0 10px 0 #cc3a3a; margin: 20px 0;
        }
        .mic-active { animation: pulse 1s infinite; background: #ff0000; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 75, 75, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 75, 75, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 75, 75, 0); } }

        .jump-btn { position: fixed; bottom: 30px; right: 30px; background: var(--b); color: white; border: none; padding: 18px 30px; border-radius: 50px; font-weight: 900; cursor: pointer; box-shadow: 0 6px 0 #1589bd; }
    </style>
</head>
<body>

    <div class="header">
        <div class="stat" style="color:var(--p)">‚≠ê LVL <span id="u-lvl">1</span></div>
        <div class="stat" style="color:var(--e)">‚ù§Ô∏è <span id="u-hearts">5</span></div>
    </div>

    <div class="path" id="map"></div>
    <button class="jump-btn" onclick="triggerJump()">‚ö° JUMP LEVEL</button>

    <div class="overlay" id="ui">
        <div class="l-header">
            <button onclick="closeLesson()" style="border:none; background:none; font-size:2.5rem; cursor:pointer; color:var(--g)">‚úï</button>
            <div class="progress"><div class="bar" id="p-bar"></div></div>
        </div>
        <div class="l-body" id="l-body"></div>
    </div>

<script>
    // --- MOTOR INFINITO GENERATIVO ---
    const engine = {
        subjects: ["The CEO", "Your sister", "Professional athletes", "A famous architect", "Most citizens", "Our team", "The scientist"],
        verbs: [
            { base: "work", gerund: "working", pp: "worked", prep: "on", lvl: 1 },
            { base: "rely", gerund: "relying", pp: "relied", prep: "on", lvl: 10 },
            { base: "succeed", gerund: "succeeding", pp: "succeeded", prep: "in", lvl: 15 },
            { base: "apologize", gerund: "apologizing", pp: "apologized", prep: "for", lvl: 20 },
            { base: "object", gerund: "objecting", pp: "objected", prep: "to", lvl: 50 }
        ],
        complements: ["the new strategy", "improving the results", "breaking the rules", "the unexpected delay", "designing the building"],
        
        generate(lvl) {
            const r = Math.random();
            const s = this.subjects[Math.floor(Math.random() * this.subjects.length)];
            const v = this.verbs.filter(x => x.lvl <= lvl).sort(() => 0.5 - Math.random())[0] || this.verbs[0];
            const c = this.complements[Math.floor(Math.random() * this.complements.length)];

            if (r > 0.7 && lvl > 5) return this.types.speaking(s, v, c);
            if (r > 0.4) return this.types.preposition(s, v, c);
            return this.types.grammar(s, v, c, lvl);
        },

        types: {
            preposition: (s, v, c) => ({
                type: "Preposition Challenge",
                q: `${s} is ${v.gerund} ____ ${c}.`,
                a: shuffle([v.prep, "at", "with"]),
                cor: v.prep
            }),
            grammar: (s, v, c, lvl) => {
                const isCond = lvl > 20 && Math.random() > 0.5;
                if(isCond) return {
                    type: "Conditional Lab",
                    q: `If ${s} ____ more time, they would have ${v.pp}.`,
                    a: shuffle(["had had", "have had", "had"]),
                    cor: "had had"
                };
                return {
                    type: "Tense Master",
                    q: `Recently, ${s} ____ ${v.pp} on that.`,
                    a: shuffle(["has been", "have been", "is"]),
                    cor: s.includes("s") || s.includes("team") ? "have been" : "has been"
                };
            },
            speaking: (s, v, c) => ({
                type: "Speaking Test",
                q: `Say: "${s} ${v.base}s ${v.prep} ${c}."`,
                cor: `${s} ${v.base}s ${v.prep} ${c}`.toLowerCase(),
                isSpeaking: true
            })
        }
    };

    function shuffle(arr) { return arr.sort(() => 0.5 - Math.random()); }

    // --- GAME STATE ---
    let userLvl = parseInt(localStorage.getItem('inf_v8')) || 1;
    let hearts = 5;
    let session = { active: false, step: 0, total: 5, qList: [] };

    // --- AUDIO & SPEECH ---
    const audio = new (window.AudioContext || window.webkitAudioContext)();
    function beep(f) {
        const o = audio.createOscillator(); const g = audio.createGain();
        o.connect(g); g.connect(audio.destination); o.frequency.value = f;
        g.gain.setValueAtTime(0.1, audio.currentTime); g.gain.linearRampToValueAtTime(0, audio.currentTime + 0.3);
        o.start(); o.stop(audio.currentTime + 0.3);
    }

    // --- LOGIC ---
    function renderMap() {
        const map = document.getElementById('map'); map.innerHTML = '';
        for(let i = 1; i <= 100; i++) {
            const btn = document.createElement('button');
            btn.className = `node ${i <= userLvl ? 'unlocked' : ''} ${i === userLvl ? 'current' : ''}`;
            btn.innerHTML = i % 10 === 0 ? 'üèÜ' : i;
            btn.onclick = () => start(i);
            btn.style.marginLeft = `${Math.sin(i * 0.8) * 60}px`;
            map.appendChild(btn);
        }
        document.getElementById('u-lvl').innerText = userLvl;
        window.scrollTo(0, document.body.scrollHeight);
    }

    function start(lvl, isJump = false) {
        if(lvl > userLvl && !isJump) return;
        session = { active: true, step: 0, total: isJump ? 8 : 5, qList: [], jump: isJump, target: lvl };
        for(let i=0; i<session.total; i++) session.qList.push(engine.generate(lvl));
        document.getElementById('ui').style.display = 'flex';
        renderQ();
    }

    function renderQ() {
        const q = session.qList[session.step];
        const body = document.getElementById('l-body');
        document.getElementById('p-bar').style.width = `${(session.step / session.total) * 100}%`;
        document.getElementById('u-hearts').innerText = hearts;

        let html = `<span class="type">${q.type}</span><div class="q-text">${q.q}</div>`;
        
        if(q.isSpeaking) {
            html += `<button class="mic-btn" id="mic" onclick="startSpeech()">üé§</button><p id="speech-txt">Tap to speak</p>`;
        } else {
            html += `<div id="opts">${q.a.map(opt => `<button class="opt" onclick="check('${opt}', '${q.cor}')">${opt}</button>`).join('')}</div>`;
        }
        body.innerHTML = html;
    }

    function check(ans, cor) {
        if(ans.toLowerCase().replace(/[.,!]/g, '') === cor.toLowerCase().replace(/[.,!]/g, '')) {
            beep(800);
            session.step++;
            if(session.step >= session.total) {
                if(session.jump) userLvl = session.target; else if(session.target === userLvl) userLvl++;
                localStorage.setItem('inf_v8', userLvl);
                alert("LEVEL COMPLETE!"); closeLesson(); renderMap();
            } else renderQ();
        } else {
            beep(200); hearts--;
            if(hearts <= 0) { alert("GAME OVER"); location.reload(); }
            renderQ();
        }
    }

    function startSpeech() {
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'en-US';
        const mic = document.getElementById('mic');
        recognition.onstart = () => mic.classList.add('mic-active');
        recognition.onresult = (e) => {
            const transcript = e.results[0][0].transcript;
            document.getElementById('speech-txt').innerText = `You said: "${transcript}"`;
            setTimeout(() => check(transcript, session.qList[session.step].cor), 1000);
        };
        recognition.onerror = () => { mic.classList.remove('mic-active'); alert("Mic error. Ensure HTTPS or local file."); };
        recognition.onend = () => mic.classList.remove('mic-active');
        recognition.start();
    }

    function triggerJump() {
        const target = userLvl + 10;
        if(confirm(`Certify Level ${target}? Fail = Game Over.`)) start(target, true);
    }

    function closeLesson() { document.getElementById('ui').style.display = 'none'; }
    renderMap();
</script>
</body>
</html>
