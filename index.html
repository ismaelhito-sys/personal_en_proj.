<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Nexus - Intermediate Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1; /* Indigo */
            --primary-dark: #4f46e5;
            --accent: #06b6d4; /* Cyan */
            --success: #10b981;
            --error: #ef4444;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-dark: #1f2937;
            --text-light: #6b7280;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--text-dark);
        }

        .app-container {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 700px;
            overflow: hidden;
            position: relative;
        }

        /* Header & Progress */
        .header {
            padding: 2rem 2rem 1rem;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 1.8rem;
            background: linear-gradient(to right, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .progress-container {
            height: 6px;
            background: #e5e7eb;
            margin-top: 1rem;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--accent));
            width: 0%;
            transition: width 0.6s ease;
        }

        /* Main Content Area */
        .content-area {
            padding: 2rem;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Mode Switcher (Study vs Challenge) */
        .mode-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }
        .mode-study { background: #e0e7ff; color: var(--primary-dark); }
        .mode-challenge { background: #ffedd5; color: #c2410c; }

        /* Flashcard Styles */
        .main-phrase {
            font-size: 1.6rem;
            font-weight: 600;
            line-height: 1.4;
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        .highlight { color: var(--primary); font-weight: 700; }

        .translation-box {
            background: #f3f4f6;
            padding: 1rem;
            border-left: 4px solid var(--accent);
            border-radius: 8px;
            color: var(--text-light);
            font-style: italic;
            display: none; /* Hidden by default */
            margin-bottom: 1.5rem;
        }

        .context-info {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 2rem;
        }
        
        /* Quiz Styles */
        .quiz-options { list-style: none; padding: 0; margin: 0 0 1.5rem 0; }
        .quiz-btn {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 8px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 12px;
            text-align: left;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .quiz-btn:hover { border-color: var(--primary); background: #eef2ff; }
        .quiz-btn.correct { background: #d1fae5; border-color: var(--success); color: #065f46; }
        .quiz-btn.wrong { background: #fee2e2; border-color: var(--error); color: #991b1b; }

        /* Controls & Mic */
        .controls-bar {
            padding: 1.5rem 2rem;
            background: rgba(255,255,255,0.5);
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: transform 0.2s, opacity 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        .btn:active { transform: translateY(0); }

        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
        .btn-secondary { background: #e5e7eb; color: var(--text-dark); }
        
        .mic-container { position: relative; }
        .btn-mic {
            width: 60px; height: 60px; border-radius: 50%; padding: 0;
            justify-content: center; font-size: 1.5rem;
            background: linear-gradient(135deg, var(--error), #c026d3); color: white;
             box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }
        .mic-active { animation: pulse 1.5s infinite; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Feedback Messages */
        #feedback-message {
            text-align: center; font-weight: 600; min-height: 1.2em;
            margin-top: 1rem; transition: color 0.3s;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="app-container">
    <header class="header">
        <h1>English Nexus <span>Hub</span></h1>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
    </header>

    <div class="content-area" id="content-area">
        </div>

    <div class="controls-bar" id="controls-bar">
        <button class="btn btn-secondary" id="btn-audio" onclick="playAudio()">üîä Listen</button>
        <button class="btn btn-secondary" id="btn-reveal" onclick="toggleTranslation()">üëÅÔ∏è Reveal</button>
        
        <div class="mic-container hidden" id="mic-wrapper">
             <button class="btn btn-mic" id="btn-mic" onmousedown="startListening()" onmouseup="stopListening()">üé§</button>
        </div>

        <button class="btn btn-primary" id="btn-action" onclick="handleAction()">Start Challenge ‚Üí</button>
    </div>
     <p id="feedback-message"></p>
     <p style="text-align: center; font-size: 0.8rem; opacity: 0.7; margin-bottom: 1rem;">*If mic fails, try running locally outside chat*</p>
</div>

<script>
    // ================= DATASET (10 Items) =================
    const database = [
        {
            id: 1,
            phrase: "I've been <span class='highlight'>putting off</span> this report all week, but I must do it today.",
            translation: "He estado posponiendo este informe toda la semana, pero debo hacerlo hoy.",
            context: "Phrasal Verb (Procrastination)",
            type: "quiz",
            question: "Which sentence uses 'put off' correctly?",
            options: ["The smell put me off my food.", "I put off my coat when I entered.", "Can you put me off at the next station?"],
            correctIndex: 0 // A is correct (to discourage/repel)
        },
        {
            id: 2,
            phrase: "If I <span class='highlight'>hadn't missed</span> the train, I <span class='highlight'>would be</span> in London now.",
            translation: "Si no hubiera perdido el tren, estar√≠a en Londres ahora.",
            context: "Mixed Conditional (Past regret -> Present consequence)",
            type: "speak",
            targetText: "If I hadn't missed the train, I would be in London now."
        },
        {
            id: 3,
            phrase: "We need to <span class='highlight'>look into</span> alternative energy sources immediately.",
            translation: "Necesitamos investigar fuentes de energ√≠a alternativas inmediatamente.",
            context: "Phrasal Verb (Investigate)",
            type: "quiz",
            question: "What is a formal synonym for 'look into'?",
            options: ["Discover", "Investigate", "Watch"],
            correctIndex: 1
        },
        {
            id: 4,
            phrase: "The new policy is expected to <span class='highlight'>bring about</span> significant changes.",
            translation: "Se espera que la nueva pol√≠tica provoque cambios significativos.",
            context: "Phrasal Verb (Cause to happen)",
            type: "speak",
            targetText: "The new policy is expected to bring about significant changes."
        },
        {
             id: 5,
            phrase: "Hardly <span class='highlight'>had I arrived</span> when the phone rang.",
            translation: "Apenas hab√≠a llegado cuando son√≥ el tel√©fono.",
            context: "Inversion (Formal emphasis)",
             type: "quiz",
             question: "Choose the correct alternative structure:",
             options: ["No sooner had I arrived than the phone rang.", "As soon as I arrived, the phone rung.", "Barely I had arrived when the phone rang."],
             correctIndex: 0
        },
         {
            id: 6,
            phrase: "I can't <span class='highlight'>put up with</span> this noise any longer.",
            translation: "No puedo aguantar este ruido m√°s tiempo.",
            context: "Phrasal Verb (Tolerate)",
            type: "speak",
            targetText: "I can't put up with this noise any longer."
        },
         {
            id: 7,
            phrase: "It's high time you <span class='highlight'>started</span> taking this seriously.",
            translation: "Ya es hora de que empieces a tomarte esto en serio.",
            context: "Unreal Past ('It's high time' + Past Simple)",
            type: "quiz",
            question: "Why do we use past tense 'started'?",
            options: ["Because it happened yesterday.", "It refers to a hypothetical present/future necessity.", "It is a passive construction."],
            correctIndex: 1
        },
         {
            id: 8,
            phrase: "They <span class='highlight'>are believed to have left</span> the country already.",
            translation: "Se cree que ya han abandonado el pa√≠s.",
            context: "Passive Voice with Reporting Verbs",
             type: "speak",
             targetText: "They are believed to have left the country already."
        },
        {
            id: 9,
            phrase: "We've run <span class='highlight'>out of</span> milk; I need to go to the shop.",
            translation: "Nos hemos quedado sin leche; necesito ir a la tienda.",
            context: "Phrasal Verb (Exhaust supply)",
            type: "quiz",
            question: "Complete: 'I'm trying to cut ____ ____ sugar.'",
            options: ["down on", "out of", "away from"],
            correctIndex: 0
        },
        {
            id: 10,
            phrase: "Despite <span class='highlight'>feeling</span> unwell, she went to work.",
            translation: "A pesar de sentirse mal, fue a trabajar.",
            context: "Contrast Connector + Gerund",
            type: "speak",
            targetText: "Despite feeling unwell, she went to work."
        }
    ];

    // ================= STATE MANAGEMENT =================
    let currentIndex = 0;
    let isStudyMode = true; // true = Study, false = Challenge
    let recognition;
    let isListening = false;

    // DOM Elements
    const contentArea = document.getElementById('content-area');
    const progressBar = document.getElementById('progress-bar');
    const btnAction = document.getElementById('btn-action');
    const btnAudio = document.getElementById('btn-audio');
    const btnReveal = document.getElementById('btn-reveal');
    const micWrapper = document.getElementById('mic-wrapper');
    const feedbackMsg = document.getElementById('feedback-message');

    // ================= CORE FUNCTIONS =================
    function init() {
        setupSpeechRecognition();
        renderState();
    }

    function renderState() {
        updateProgress();
        feedbackMsg.innerText = "";
        feedbackMsg.className = "";

        if (isStudyMode) {
            renderStudyMode();
        } else {
            renderChallengeMode();
        }
    }

    function renderStudyMode() {
        const item = database[currentIndex];
        contentArea.innerHTML = `
            <span class="mode-badge mode-study">Study Phase</span>
            <div class="main-phrase">${item.phrase}</div>
            <div class="translation-box" id="translation">${item.translation}</div>
            <div class="context-info">üí° Context: ${item.context}</div>
        `;
        // Reset controls for study mode
        btnAction.innerText = "Start Challenge ‚Üí";
        btnAction.onclick = handleAction;
        btnAudio.classList.remove('hidden');
        btnReveal.classList.remove('hidden');
        micWrapper.classList.add('hidden');
    }

    function renderChallengeMode() {
        const item = database[currentIndex];
        btnAudio.classList.add('hidden');
        btnReveal.classList.add('hidden');

        if (item.type === 'quiz') {
            renderQuiz(item);
        } else if (item.type === 'speak') {
            renderSpeak(item);
        }
    }

    // ----- QUIZ LOGIC -----
    function renderQuiz(item) {
         micWrapper.classList.add('hidden');
         let optionsHTML = item.options.map((opt, index) => 
             `<li><button class="quiz-btn" onclick="checkAnswer(${index})">${opt}</button></li>`
         ).join('');

         contentArea.innerHTML = `
            <span class="mode-badge mode-challenge">Quiz Challenge</span>
            <div class="main-phrase" style="font-size: 1.3rem">${item.question}</div>
            <ul class="quiz-options">${optionsHTML}</ul>
        `;
        btnAction.classList.add('hidden'); // Hide until answered
    }

    function checkAnswer(selectedIndex) {
        const item = database[currentIndex];
        const buttons = document.querySelectorAll('.quiz-btn');
        
        if (selectedIndex === item.correctIndex) {
            buttons[selectedIndex].classList.add('correct');
            showFeedback("Correct! Well done.", "success");
        } else {
            buttons[selectedIndex].classList.add('wrong');
            buttons[item.correctIndex].classList.add('correct');
            showFeedback("Oops! Review the correct option.", "error");
        }
        
        // Disable all buttons
        buttons.forEach(btn => btn.disabled = true);
        
        // Show next button
        btnAction.innerText = "Next Lesson ‚Üí";
        btnAction.onclick = nextLesson;
        btnAction.classList.remove('hidden');
    }

    // ----- SPEAKING LOGIC -----
    function renderSpeak(item) {
        micWrapper.classList.remove('hidden');
        contentArea.innerHTML = `
            <span class="mode-badge mode-challenge">Pronunciation Challenge</span>
            <p style="margin-bottom: 1rem;">Press and HOLD the mic button and read the phrase aloud:</p>
            <div class="main-phrase" style="font-size: 1.3rem; color: var(--primary-dark)">
                "${item.targetText}"
            </div>
            <p id="speech-output" style="font-style:italic; color: #666; min-height: 1.5em">...</p>
        `;
         btnAction.classList.add('hidden'); // Hide until spoken
    }

    function setupSpeechRecognition() {
        // Check browser support
        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = true;
            recognition.continuous = false;

            recognition.onstart = () => {
                isListening = true;
                document.getElementById('btn-mic').classList.add('mic-active');
                document.getElementById('speech-output').innerText = "Listening...";
            };

            recognition.onresult = (event) => {
                const transcript = Array.from(event.results)
                    .map(result => result[0])
                    .map(result => result.transcript)
                    .join('');
                document.getElementById('speech-output').innerText = `You said: "${transcript}"`;
                evaluateSpeech(transcript);
            };

            recognition.onend = () => {
                 isListening = false;
                 document.getElementById('btn-mic').classList.remove('mic-active');
            };

            recognition.onerror = (event) => {
                isListening = false;
                document.getElementById('btn-mic').classList.remove('mic-active');
                let msg = "Microphone error.";
                if (event.error === 'not-allowed') {
                    msg = "‚ö†Ô∏è Microphone blocked by browser security. Try running locally.";
                }
                showFeedback(msg, "error");
            };
        } else {
             micWrapper.innerHTML = "<p style='color:red; font-size:0.8rem'>Speech recognition not supported in this browser.</p>";
        }
    }

    function startListening() {
        if (recognition && !isListening) {
            feedbackMsg.innerText = "";
            try {
                 recognition.start();
            } catch (e) { console.error(e); }
        }
    }

    function stopListening() {
        if (recognition && isListening) {
            recognition.stop();
        }
    }

    function evaluateSpeech(transcript) {
        const target = database[currentIndex].targetText.toLowerCase().replace(/[.,]/g, '');
        const attempt = transcript.toLowerCase().replace(/[.,]/g, '');
        
        // Simple check: if it contains 70% of the target phrase key words
        // For simplicity here, we'll check if it includes the main verb/structure
        const item = database[currentIndex];
        // Extracting just a key part for easier matching in this demo
        const keyPart = item.phrase.replace(/<[^>]*>/g, '').split(' ').slice(1,4).join(' ').toLowerCase().replace(/[.,]/g,'');

        if (attempt.includes(keyPart) || attempt.length > target.length * 0.8) {
             showFeedback("Excellent pronunciation!", "success");
             btnAction.innerText = "Next Lesson ‚Üí";
             btnAction.onclick = nextLesson;
             btnAction.classList.remove('hidden');
        }
    }


    // ================= HELPER FUNCTIONS =================
    function handleAction() {
        if (isStudyMode) {
            // Switch to challenge
            isStudyMode = false;
            renderState();
        } else {
            nextLesson();
        }
    }

    function nextLesson() {
        currentIndex = (currentIndex + 1) % database.length;
        isStudyMode = true;
        renderState();
    }

    function toggleTranslation() {
        const el = document.getElementById('translation');
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    function playAudio() {
        // Strip HTML tags for speech
        const text = database[currentIndex].phrase.replace(/<[^>]*>/g, '');
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 0.9;
        window.speechSynthesis.speak(utterance);
    }

    function updateProgress() {
        const progress = ((currentIndex) / database.length) * 100;
        progressBar.style.width = `${progress}%`;
    }

    function showFeedback(text, type) {
        feedbackMsg.innerText = text;
        feedbackMsg.style.color = type === 'success' ? 'var(--success)' : 'var(--error)';
    }

    // Start App
    init();

</script>
</body>
</html>
