<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Quest: Progressive Mastery</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #58cc02; --boss: #854dff; --error: #ff4b4b; --gray: #e5e5e5; --blue: #1cb0f6; }
        body { font-family: 'Outfit', sans-serif; margin: 0; background: #fff; overflow-x: hidden; color: #3c3c3c; }
        
        /* Dashboard */
        .top-nav { position: sticky; top: 0; background: white; border-bottom: 2px solid var(--gray); padding: 15px; display: flex; justify-content: space-around; z-index: 100; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .stat { font-weight: 900; font-size: 1.1rem; display: flex; align-items: center; gap: 5px; }

        /* Level Map */
        .path { display: flex; flex-direction: column-reverse; align-items: center; padding: 60px 0; background: #f7f7f7; min-height: 100vh; }
        .level-node { 
            width: 80px; height: 80px; border-radius: 50%; border: none; margin: 15px 0;
            color: white; font-weight: 900; cursor: pointer; transition: 0.2s;
            box-shadow: 0 8px 0 #afafaf; background: var(--gray); font-size: 1.4rem;
        }
        .unlocked { background: var(--primary); box-shadow: 0 8px 0 #46a302; }
        .boss-node { background: #3c3c3c !important; box-shadow: 0 8px 0 #1a1a1a !important; border: 4px solid var(--boss); }
        .current { transform: scale(1.15); filter: brightness(1.1); }

        /* UI Overlays */
        .overlay { position: fixed; inset: 0; background: white; display: none; flex-direction: column; z-index: 200; }
        .lesson-header { padding: 20px; display: flex; align-items: center; gap: 15px; }
        .progress-rail { flex-grow: 1; height: 16px; background: var(--gray); border-radius: 8px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .lesson-body { padding: 40px 20px; max-width: 550px; margin: 0 auto; width: 100%; text-align: center; }
        .type-label { color: var(--blue); text-transform: uppercase; font-weight: 900; letter-spacing: 1px; font-size: 0.8rem; margin-bottom: 10px; display: block; }
        .question { font-size: 1.8rem; font-weight: 700; margin-bottom: 35px; line-height: 1.3; }

        .option-grid { display: grid; gap: 12px; }
        .opt { 
            padding: 20px; border: 2px solid var(--gray); border-bottom: 6px solid var(--gray);
            border-radius: 18px; background: white; font-size: 1.15rem; font-weight: 700;
            cursor: pointer; transition: 0.1s; text-align: left;
        }
        .opt:hover:not(:disabled) { background: #f8fafc; border-color: #cbd5e1; }
        .opt:active { transform: translateY(4px); border-bottom-width: 2px; }
        .correct { background: #dcfce7 !important; border-color: var(--primary) !important; color: #166534; }
        .wrong { background: #fee2e2 !important; border-color: var(--error) !important; color: #991b1b; }
    </style>
</head>
<body>

    <div class="top-nav">
        <div class="stat" style="color:var(--primary)">üéØ <span id="user-lvl">1</span></div>
        <div class="stat" style="color:var(--error)">‚ù§Ô∏è <span id="hearts-val">5</span></div>
        <div class="stat" style="color:var(--blue)">üíé <span id="gems-val">0</span></div>
    </div>

    <div class="path" id="map"></div>

    <div class="overlay" id="lesson-ui">
        <div class="lesson-header">
            <button onclick="exitLesson()" style="border:none; background:none; font-size:2rem; cursor:pointer">‚úï</button>
            <div class="progress-rail"><div class="progress-fill" id="p-fill"></div></div>
        </div>
        <div class="lesson-body" id="lesson-content"></div>
    </div>

<script>
    // --- DATABASE POR DIFICULTAD ---
    const content = {
        beginner: [ // Nivel 1-20
            { t: "Grammar", q: "I ___ a student.", a: ["am", "is", "are"], c: 0 },
            { t: "Translation", q: "¬øC√≥mo se dice 'Manzana'?", a: ["Pineapple", "Apple", "Grape"], c: 1 },
            { t: "Grammar", q: "She ___ to music every day.", a: ["listen", "listens", "listening"], c: 1 }
        ],
        intermediate: [ // Nivel 21-50
            { t: "Phrasal Verb", q: "I need to ___ the truth.", a: ["find out", "find in", "find up"], c: 0 },
            { t: "Conditionals", q: "If I won the lottery, I ___ a car.", a: ["will buy", "would buy", "bought"], c: 1 },
            { t: "Idiom", q: "'Break a leg' means...", a: ["Good luck", "You failed", "Accident"], c: 0 }
        ],
        advanced: [ // Nivel 51-80
            { t: "Modals", q: "He ___ have been there; he was with me.", a: ["mustn't", "can't", "shouldn't"], c: 1 },
            { t: "Passive", q: "The bridge ___ by next month.", a: ["is repaired", "will be repaired", "will have repaired"], c: 1 },
            { t: "Subjunctive", q: "It's vital that he ___ present.", a: ["is", "be", "was"], c: 1 }
        ],
        expert: [ // Nivel 81-100
            { t: "Inversion", q: "Seldom ___ such a beautiful sunset.", a: ["I have seen", "have I seen", "did I saw"], c: 1 },
            { t: "Mixed Conditional", q: "If I had studied, I ___ a degree now.", a: ["would have", "would have had", "will have"], c: 0 },
            { t: "C2 Structures", q: "Were it not for your help, I ___.", a: ["failed", "would fail", "would have failed"], c: 2 }
        ]
    };

    let userLvl = parseInt(localStorage.getItem('edu_lvl')) || 1;
    let hearts = 5;
    let currentTask = [];
    let step = 0;
    let isBoss = false;

    // Sonidos
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    function beep(f, t) {
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.type = t; o.frequency.value = f;
        g.gain.setValueAtTime(0.1, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        o.start(); o.stop(ctx.currentTime + 0.3);
    }

    function renderMap() {
        const map = document.getElementById('map'); map.innerHTML = '';
        for(let i = 1; i <= 100; i++) {
            const btn = document.createElement('button');
            const isBossLvl = i % 10 === 0;
            btn.className = `level-node ${i <= userLvl ? 'unlocked' : ''} ${i === userLvl ? 'current' : ''} ${isBossLvl ? 'boss-node' : ''}`;
            btn.innerHTML = isBossLvl ? 'üíÄ' : i;
            btn.onclick = () => startSession(i, isBossLvl);
            btn.style.marginLeft = `${Math.sin(i * 0.9) * 65}px`;
            map.appendChild(btn);
        }
        document.getElementById('user-lvl').innerText = userLvl;
        window.scrollTo(0, document.body.scrollHeight);
    }

    function startSession(lvl, boss) {
        if(lvl > userLvl || hearts <= 0) return;
        step = 0; isBoss = boss;
        
        // Seleccionar dificultad seg√∫n nivel
        let pool = content.beginner;
        if(lvl > 20) pool = content.intermediate;
        if(lvl > 50) pool = content.advanced;
        if(lvl > 80) pool = content.expert;

        currentTask = [...pool].sort(() => 0.5 - Math.random()).slice(0, boss ? 10 : 5);
        document.getElementById('lesson-ui').style.display = 'flex';
        renderQuestion();
    }

    function renderQuestion() {
        const q = currentTask[step];
        const contentEl = document.getElementById('lesson-content');
        document.getElementById('p-fill').style.width = `${(step / currentTask.length) * 100}%`;

        contentEl.innerHTML = `
            <span class="type-label">${q.t} ${isBoss ? '‚Ä¢ BOSS MODE' : ''}</span>
            <div class="question">${q.q}</div>
            <div class="option-grid">
                ${q.a.map((opt, i) => `<button class="opt" onclick="check(${i}, ${q.c})">${opt}</button>`).join('')}
            </div>
        `;
    }

    function check(idx, correct) {
        const btns = document.querySelectorAll('.opt');
        btns.forEach(b => b.disabled = true);

        if(idx === correct) {
            btns[idx].classList.add('correct'); beep(600, 'sine');
            setTimeout(() => {
                step++;
                if(step < currentTask.length) renderQuestion();
                else finish();
            }, 800);
        } else {
            btns[idx].classList.add('wrong'); beep(150, 'triangle');
            hearts--; document.getElementById('hearts-val').innerText = hearts;
            if(isBoss || hearts <= 0) {
                alert(isBoss ? "BOSS DEFEATED YOU! Start level again." : "No more lives!");
                exitLesson();
            } else {
                setTimeout(() => { btns.forEach(b => b.disabled = false); btns[idx].classList.remove('wrong'); }, 800);
            }
        }
    }

    function finish() {
        if(userLvl < 100) userLvl++;
        localStorage.setItem('edu_lvl', userLvl);
        alert("Level Clear! +10 XP");
        exitLesson(); renderMap();
    }

    function exitLesson() { document.getElementById('lesson-ui').style.display = 'none'; }
    renderMap();
</script>
</body>
</html>
            btn.className = `level-node ${i <= userLvl ? 'unlocked' : ''} ${i === userLvl ? 'current' : ''}`;
            btn.innerHTML = i;
            btn.onclick = () => startSession(i);
            btn.style.marginLeft = `${Math.sin(i * 0.8) * 60}px`;
            map.appendChild(btn);
        }
        document.getElementById('user-lvl').innerText = userLvl;
        window.scrollTo(0, document.body.scrollHeight);
    }

    function startSession(lvl) {
        if(lvl > userLvl || totalHearts <= 0) return;
        currentStep = 0;
        // Mezclamos y seleccionamos 5 preguntas √∫nicas
        currentQuestions = [...questionBank].sort(() => 0.5 - Math.random()).slice(0, QUESTIONS_PER_LEVEL);
        document.getElementById('lesson-ui').style.display = 'flex';
        renderQuestion();
    }

    function renderQuestion() {
        const q = currentQuestions[currentStep];
        const body = document.getElementById('lesson-body');
        document.getElementById('lesson-hearts').innerText = totalHearts;
        document.getElementById('p-bar').style.width = `${(currentStep / QUESTIONS_PER_LEVEL) * 100}%`;

        body.innerHTML = `
            <div class="q-text">${q.q}</div>
            <div id="opts">
                ${q.a.map((opt, i) => `<button class="option" onclick="handleSelect(this, ${i})">${opt}</button>`).join('')}
            </div>
        `;
    }

    function handleSelect(btn, idx) {
        const q = currentQuestions[currentStep];
        const allOpts = document.querySelectorAll('.option');
        allOpts.forEach(o => o.style.pointerEvents = 'none');

        if(idx === q.c) {
            btn.classList.add('correct');
            playSound(880, 'sine'); // Sonido acierto (La5)
            setTimeout(() => {
                currentStep++;
                if(currentStep < QUESTIONS_PER_LEVEL) {
                    renderQuestion();
                } else {
                    completeLevel();
                }
            }, 1000);
        } else {
            btn.classList.add('wrong');
            playSound(220, 'square'); // Sonido fallo (La3)
            totalHearts--;
            document.getElementById('lesson-hearts').innerText = totalHearts;
            document.getElementById('global-hearts').innerText = totalHearts;
            
            setTimeout(() => {
                if(totalHearts <= 0) {
                    alert("GAME OVER - Vuelve a empezar");
                    location.reload();
                } else {
                    renderQuestion(); // Re-intenta la misma
                }
            }, 1000);
        }
    }

    function completeLevel() {
        if(userLvl < 100) userLvl++;
        localStorage.setItem('userLvl', userLvl);
        alert("¬°Nivel superado!");
        exitLesson();
        renderMap();
    }

    function exitLesson() {
        document.getElementById('lesson-ui').style.display = 'none';
    }

    renderMap();
</script>
</body>
</html>
        { q: "Unless it ___ , we'll go out.", a: ["rains", "will rain", "rained"], c: 0, tag: "conditional" }
    ];

    let userLvl = parseInt(localStorage.getItem('userLvl')) || 1;
    let totalHearts = 5;
    let currentQuestions = [];
    let currentStep = 0;
    const QUESTIONS_PER_LEVEL = 5;

    // --- SOUND ENGINE (Web Audio API) ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(freq, type) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.type = type; osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        osc.start(); osc.stop(audioCtx.currentTime + 0.3);
    }

    // --- GAME LOGIC ---
    function renderMap() {
        const map = document.getElementById('map');
        map.innerHTML = '';
        for(let i = 1; i <= 100; i++) {
            const btn = document.createElement('button');
            btn.className = `level-node ${i <= userLvl ? 'unlocked' : ''} ${i === userLvl ? 'current' : ''}`;
            btn.innerHTML = i;
            btn.onclick = () => startSession(i);
            btn.style.marginLeft = `${Math.sin(i * 0.8) * 60}px`;
            map.appendChild(btn);
        }
        document.getElementById('user-lvl').innerText = userLvl;
        window.scrollTo(0, document.body.scrollHeight);
    }

    function startSession(lvl) {
        if(lvl > userLvl || totalHearts <= 0) return;
        currentStep = 0;
        // Mezclamos y seleccionamos 5 preguntas √∫nicas
        currentQuestions = [...questionBank].sort(() => 0.5 - Math.random()).slice(0, QUESTIONS_PER_LEVEL);
        document.getElementById('lesson-ui').style.display = 'flex';
        renderQuestion();
    }

    function renderQuestion() {
        const q = currentQuestions[currentStep];
        const body = document.getElementById('lesson-body');
        document.getElementById('lesson-hearts').innerText = totalHearts;
        document.getElementById('p-bar').style.width = `${(currentStep / QUESTIONS_PER_LEVEL) * 100}%`;

        body.innerHTML = `
            <div class="q-text">${q.q}</div>
            <div id="opts">
                ${q.a.map((opt, i) => `<button class="option" onclick="handleSelect(this, ${i})">${opt}</button>`).join('')}
            </div>
        `;
    }

    function handleSelect(btn, idx) {
        const q = currentQuestions[currentStep];
        const allOpts = document.querySelectorAll('.option');
        allOpts.forEach(o => o.style.pointerEvents = 'none');

        if(idx === q.c) {
            btn.classList.add('correct');
            playSound(880, 'sine'); // Sonido acierto (La5)
            setTimeout(() => {
                currentStep++;
                if(currentStep < QUESTIONS_PER_LEVEL) {
                    renderQuestion();
                } else {
                    completeLevel();
                }
            }, 1000);
        } else {
            btn.classList.add('wrong');
            playSound(220, 'square'); // Sonido fallo (La3)
            totalHearts--;
            document.getElementById('lesson-hearts').innerText = totalHearts;
            document.getElementById('global-hearts').innerText = totalHearts;
            
            setTimeout(() => {
                if(totalHearts <= 0) {
                    alert("GAME OVER - Vuelve a empezar");
                    location.reload();
                } else {
                    renderQuestion(); // Re-intenta la misma
                }
            }, 1000);
        }
    }

    function completeLevel() {
        if(userLvl < 100) userLvl++;
        localStorage.setItem('userLvl', userLvl);
        alert("¬°Nivel superado!");
        exitLesson();
        renderMap();
    }

    function exitLesson() {
        document.getElementById('lesson-ui').style.display = 'none';
    }

    renderMap();
</script>
</body>
</html>
